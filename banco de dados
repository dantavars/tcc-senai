const express = require('express')
const bodyParser = require('body-parser')
const mongoose = require("mongoose")
const app = express()

//body parser 
app.use(bodyParser.urlencoded({extended:true}))
app.use(bodyParser.json())





// Configurando o mongoose
mongoose.Promise = global.Promise;
mongoose.connect("mongodb://localhost/aprendendo", {
    useMongoClient: true
}).then(() => {
    console.log("MongoDB Conectado...")
}).catch((err) => {
    console.log("Houve um erro ao se conectar ao mongoDB: "+err)
})
// Model - Usuários 

const UsuarioSchema = mongoose.Schema({
    
    nome: {
        type: String,
        required: true 
    },
    sobrenome: {
        type: String,
        required: true 
    },
    cpf: {
        type: Number,
        required: true,
        unique: true 
    },
   senha: {
    type: String,
    required: true 
    }
})

// Collection 
const Usuario = mongoose.model('Usuarios', UsuarioSchema)

// Model Multa 
const MultaSchema = mongoose.Schema({

    usuarioId: {
        type: mongoose.Schema.Types.ObjectId,
        ref: "Usuarios",
        required: true
    },

    descricao: String,
    valor: Number,
    status: {
        type: String,
        default: "pendente"
    }

})

const Multa = mongoose.model("Multas", MultaSchema)

app.post("/criar-multa", async (req, res) => {

    try {

        // 1️⃣ procura o usuário pelo CPF
        const usuario = await Usuario.findOne({ cpf: req.body.cpf })

        if (!usuario) {
            return res.send("Usuário não encontrado")
        }

        // 2️⃣ cria multa vinculada ao _id
        const novaMulta = new Multa({
            usuarioId: usuario._id,
            descricao: req.body.descricao,
            valor: req.body.valor
        })

        await novaMulta.save()

        res.send("Multa criada com sucesso!")

    } catch (err) {
        res.send("Erro ao criar multa: " + err)
    }

})

// rota registro
app.post("/registro", async (req, res) => {

    try {

        const existe = await Usuario.findOne({ cpf: req.body.cpf })

        if(existe){
            return res.send("CPF já registrado")
        }

        const novoUsuario = new Usuario({
            nome: req.body.nome,
            sobrenome: req.body.sobrenome,
            cpf: req.body.cpf,
            senha: req.body.senha
        })

        await novoUsuario.save()

        res.send("Usuário registrado com sucesso")

    } catch(err){
        res.send("Erro: " + err)
    }

})


// rota login
app.post("/login", async (req, res) => {

    try {

        const usuario = await Usuario.findOne({
            cpf: req.body.cpf,
            senha: req.body.senha
        })

        if (!usuario) {

            return res.json({
                sucesso: false,
                mensagem: "Usuário ou senha incorretos"
            })

        }

        // buscar multas do usuário pelo _id
        const multas = await Multa.find({
            usuarioId: usuario._id
        })

        res.json({

            sucesso: true,
            nome: usuario.nome,
            sobrenome: usuario.sobrenome,
            multas: multas

        })

    } catch (err) {

        res.send("Erro no login: " + err)

    }

})

const PORT = 8081
app.listen(PORT, () => {
    console.log("Servidor rodando na porta 8081")
})


